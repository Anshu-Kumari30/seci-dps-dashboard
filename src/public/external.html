<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Energy Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .tab-content {
        margin-top: 20px;
      }
    </style>
  </head>
  <body class="p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">Energy Management</h2>
      <a href="/home.html" class="btn btn-secondary">Back to Home</a>
    </div>

    <!-- <div class="mb-3">
      <label for="statisticDropdown" class="form-label">Select Statistic</label>
      <select id="statisticDropdown" class="form-select"></select>
    </div> -->

    <div class="mb-3">
      <h4 id="statisticTitle" class="mb-1"></h4>
      <h5 id="entityTitle" class="text-muted"></h5>
    </div>

    <ul class="nav nav-tabs" id="dynamicTabs" role="tablist"></ul>
    <div class="tab-content" id="dynamicTabContent"></div>

    <script src="./js/main.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);
        const dept_id = params.get("dept_id");
        const statistic_id = params.get("statistic_id");
        const entity_id = params.get("entity_id");
        const statisticDropdown = document.getElementById("statisticDropdown");

        Promise.all([
          authFetch(`/api/data/statistics/${dept_id}`),
          authFetch(`/api/data/entities/${dept_id}/${statistic_id}`),
        ])
          .then(([statsRes, entitiesRes]) =>
            Promise.all([statsRes.json(), entitiesRes.json()])
          )
          .then(([stats, entities]) => {
            const stat = stats.find((s) => s.statistic_id == statistic_id);
            const entity = entities.find((e) => e.entity_id == entity_id);

            document.getElementById("statisticTitle").innerText =
              stat?.statistic_name || "Statistic";
            document.getElementById("entityTitle").innerText =
              entity?.entity_name || "Entity";

            loadTabsForStatistic(statistic_id, entity_id);
          });

        statisticDropdown.addEventListener("change", (e) => {
          loadTabsForStatistic(e.target.value);
        });

        function loadTabsForStatistic(statistic_id) {
          authFetch(
            `/api/data/documents/grouped/${dept_id}/${statistic_id}/${entity_id}`
          )
            .then((res) => res.json())
            .then((data) => {
              console.log(data);
              populateTabs(data, dept_id, statistic_id, entity_id);
            });
        }

        function populateTabs(data, dept_id, statistic_id, entity_id) {
          const tabList = document.getElementById("dynamicTabs");
          const tabContent = document.getElementById("dynamicTabContent");

          tabList.innerHTML = "";
          tabContent.innerHTML = "";

          // Replaced tabs: show grouped document categories
          const types = [
            {
              id: "dp",
              label: "Developer Payment",
              source: "documents",
              docTypes: ["dp"],
              docTypeForAdd: "dp",
              titleForAdd: "Developer Payment",
            },
            {
              id: "sp",
              label: "Powersale Status",
              source: "documents",
              docTypes: ["sp"],
              docTypeForAdd: "sp",
              titleForAdd: "Powersale Status",
            },
            {
              id: "discom",
              label: "DISCOM Payment and Outstanding Dues",
              source: "documents",
              docTypes: ["discom"],
              docTypeForAdd: "discom",
              titleForAdd: "DISCOM Payment and Outstanding Dues",
            },
            {
              id: "ro",
              label: "Regulatory Order",
              source: "documents",
              docTypes: ["ro"],
              docTypeForAdd: "ro",
              titleForAdd: "Regulatory Order",
            },
            {
              id: "swd",
              label: "State-wise Data",
              source: "documents",
              docTypes: ["swd"],
              docTypeForAdd: "swd",
              titleForAdd: "State-wise Data",
            },
          ];

          types.forEach((type, index) => {
            const tabId = `tab-${type.id}`;
            const isActive = index === 0 ? "active" : "";
            const isShow = index === 0 ? "show active" : "";

            const tabButton = document.createElement("li");
            tabButton.className = "nav-item";
            tabButton.innerHTML = `
      <button class="nav-link ${isActive}" id="${tabId}-tab" data-bs-toggle="tab" data-bs-target="#${tabId}" type="button" role="tab">
        ${type.label}
      </button>`;
            tabList.appendChild(tabButton);

            const pane = document.createElement("div");
            pane.className = `tab-pane fade ${isShow}`;
            pane.id = tabId;
            pane.role = "tabpanel";

            let items = [];
            if (type.id === "swd") {
              items = (data.stateWiseData || []).filter((swd) => {
                return (
                  swd.statistic_id == statistic_id &&
                  swd.entity_id == entity_id
                );
              });
            } else if (type.source === "documents") {
              items = (data.documents || []).filter((doc) => {
                const typeMatch = type.docTypes
                  ? type.docTypes.includes(doc.doc_type)
                  : doc.doc_type === type.id;
                return (
                  typeMatch &&
                  doc.statistic_id == statistic_id &&
                  doc.entity_id == entity_id
                );
              });
            } else if (type.source === "correspondences") {
              items = (data.correspondences || []).filter(
                (c) =>
                  c.correspondence_type === type.filter &&
                  c.statistic_id == statistic_id &&
                  c.entity_id == entity_id
              );
            } else if (type.source === "issues") {
              items = (data.issues || []).filter(
                (issue) =>
                  issue.statistic_id == statistic_id &&
                  issue.entity_id == entity_id
              );
            }


            // Add only the "+ Add ..." button
            const addButton = document.createElement("button");
            addButton.className = "btn btn-sm btn-success mb-2";
            addButton.innerText = `+ Add ${type.label}`;
            addButton.onclick = () => {
              if (type.id === "swd") {
                window.location.href = `/add_state_wise_data.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else if (type.source === "documents") {
                const docType = type.docTypeForAdd || (type.docTypes && type.docTypes[0]) || type.id;
                const title = encodeURIComponent(type.titleForAdd || type.label);
                window.location.href = `/add_contract_document.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}&doc_type=${docType}&title=${title}`;
              } else if (type.label === "Correspondences with Contractors") {
                window.location.href = `/add_correspondence_contractor.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else if (type.label === "Correspondences with other Stakeholders") {
                window.location.href = `/add_correspondence_other.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else if (type.label === "Key Issues") {
                window.location.href = `/add_issues.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else {
                alert("Coming Soon...");
              }
            };
            pane.appendChild(addButton);

            // Add the data table
            const table = buildDocumentTable(items, type);
            table.className = "table table-bordered";
            pane.appendChild(table);
            tabContent.appendChild(pane);
          });
        }
        function buildDocumentTable(items, type) {
          const table = document.createElement("table");
          table.className = "table table-bordered";
          const thead = document.createElement("thead");
          const tbody = document.createElement("tbody");

          let columns = "";
          if (type.id === "is" || type.source === "issues") {
            columns = `
            <tr>
              <th class="sortable">S. No.</th>
              <th class="sortable">Issue Description</th>
              <th class="sortable">Issue Pertaining To</th>
              <th class="sortable">Issue Date</th>
              <th>View Issue Document</th>
              <th class="sortable">Uploaded On</th>
              <th>action</th>
            </tr>`;
          } else if (type.id === "swd") {
            columns = `
              <tr>
              <th class="sortable">S. No.</th>
              <th class="sortable">Name</th>
              <th class="sortable">PSA Signed (MW)</th>
              <th class="sortable">Commissioned (MW)</th>
                <th class="sortable">Regulations / Policy</th>
                <th class="sortable">Report</th>
                <th>Edit</th>
                <th>Modify</th>
                <th>Delete</th>
              </tr>`;
          } else if (type.source === "documents") {
            columns = `
              <tr>
              <th class="sortable">S. No.</th>
              <th class="sortable">Document Name</th>
              <th class="sortable">Dated</th>
              <th>View Document</th>
              <th class="sortable">Uploaded On</th>
              <th></th>
              </tr>`;
          } else {
            columns = `
              <tr>
  <th class="sortable">S. No.</th>
  <th class="sortable">Subject</th>
  <th class="sortable">Dated</th>
  <th class="sortable">From</th>
  <th class="sortable">To</th>
  <th class="sortable">Uploaded On</th>
  <th>View</th>
  <th></th>
</tr>
            `;
          }

          thead.innerHTML = columns;

          let index = 1;
          items.forEach((item) => {
            const tr = document.createElement("tr");

            if (type.id === "is" || type.source === "issues") {
              tr.innerHTML = `
              <td>${index}</td>
              <td>${item.issue_description}</td>
              <td>${item.issue_pertaining_to}</td>
<td data-sort-value="${item.issue_date}">
  ${formatToISTDate(item.issue_date)}
</td>              <td>
                ${
                  item.issue_doc_path
                    ? `<a href="${item.issue_doc_path}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>`
                    : `<button class="btn btn-sm btn-secondary" disabled>No Document</button>`
                }
              </td>
<td data-sort-value="${item.createdAt}">
  ${formatToISTDate(item.createdAt)}
</td>              <td><button class="btn btn-danger btn-sm" data-is-id="${
                item.issue_id
              }" onclick="deleteIssue(event)">Delete</button></td>`;
            } else if (type.id === "swd") {
              const renderPolicyFiles = () => {
                try {
                  let policies = [];
                  if (item.regulations_policy) {
                    if (item.regulations_policy.startsWith('[')) {
                      policies = JSON.parse(item.regulations_policy);
                    } else {
                      policies = [item.regulations_policy];
                    }
                  }
                  if (policies.length === 0) {
                    return `<button class="btn btn-sm btn-secondary" disabled>No Policy</button>`;
                  }
                  return policies.map((policy, idx) => 
                    `<a href="${policy}" target="_blank" class="btn btn-sm btn-outline-primary mb-1">View ${idx+1}</a>`
                  ).join(' ');
                } catch (e) {
                  return item.regulations_policy 
                    ? `<a href="${item.regulations_policy}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>`
                    : `<button class="btn btn-sm btn-secondary" disabled>No Policy</button>`;
                }
              };

              const renderReportFiles = () => {
                try {
                  let reports = [];
                  if (item.report_path) {
                    if (item.report_path.startsWith('[')) {
                      reports = JSON.parse(item.report_path);
                    } else {
                      reports = [item.report_path];
                    }
                  }
                  if (reports.length === 0) {
                    return `<button class="btn btn-sm btn-secondary" disabled>No Report</button>`;
                  }
                  return reports.map((report, idx) => 
                    `<a href="${report}" target="_blank" class="btn btn-sm btn-info mb-1">View ${idx+1}</a>`
                  ).join(' ');
                } catch (e) {
                  return item.report_path 
                    ? `<a href="${item.report_path}" target="_blank" class="btn btn-sm btn-info">View</a>`
                    : `<button class="btn btn-sm btn-secondary" disabled>No Report</button>`;
                }
              };

              tr.innerHTML = `
              <td>${index}</td>
              <td>${item.name}</td>
              <td>${(item.psa_signed_mw !== undefined && item.psa_signed_mw !== null) ? parseFloat(item.psa_signed_mw).toFixed(2) : '-'}</td>
              <td>${(item.commissioned_mw !== undefined && item.commissioned_mw !== null) ? parseFloat(item.commissioned_mw).toFixed(2) : '-'}</td>
              <td>${renderPolicyFiles()}</td>
              <td>${renderReportFiles()}</td>
              <td><button class="btn btn-warning btn-sm" onclick="editStateWiseData('${item.swd_id}')">Edit</button></td>
              <td><button class="btn btn-danger btn-sm" onclick="deleteStateWiseData(event, '${item.swd_id}')">Delete</button></td>`;
            } else if (type.source === "documents") {
              tr.innerHTML = `
              <td>${index}</td>
              <td>${item.doc_name}</td>
              <td data-sort-value="${item.doc_date}">
  ${formatToISTDate(item.doc_date)}
</td>

              <td><a href="${
                item.doc_path
              }" target="_blank" class="btn btn-sm btn-outline-primary">View</a></td>
<td data-sort-value="${item.createdAt}">
  ${formatToISTDate(item.createdAt)}
</td>
              <td>
                <button class="btn btn-warning btn-sm" onclick="editContractDocument('${item.doc_id}')">Edit</button>
                <button class="btn btn-danger btn-sm" data-doc-id="${item.doc_id}" onclick="deleteDocument(event)">Delete</button>
              </td>`;
            } else {
              tr.innerHTML = `
        <td>${index}</td>
        <td>${item.subject || ""}</td>
<td data-sort-value="${item.correspondence_date}">
  ${formatToISTDate(item.correspondence_date)}
</td>        <td>${item.from || ""}</td>
        <td>${item.to || ""}</td>
<td data-sort-value="${item.createdAt}">
  ${formatToISTDate(item.createdAt)}
</td>        <td><a href="${
                item.doc_path
              }" target="_blank" class="btn btn-sm btn-outline-primary">View</a></td>
        <td><button class="btn btn-danger btn-sm" data-corr-id="${
          item.correspondence_id
        }" onclick="deleteCorrespondence(event)">Delete</button></td>`;
            }

            tbody.appendChild(tr);
            index++;
          });

          table.appendChild(thead);
          table.appendChild(tbody);
          return table;
        }
      });

      function authFetch(url, options = {}) {
        const token = localStorage.getItem("token");
        const defaultHeaders = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        };

        return fetch(url, {
          ...options,
          headers: {
            ...defaultHeaders,
            ...(options.headers || {}),
          },
        }).then((res) => {
          if (res.status === 401) {
            alert("Session expired. Redirecting to login...");
            localStorage.clear();
            window.location.href = "/";
            throw new Error("Unauthorized");
          }
          return res;
        });
      }

      function formatToISTDate(dateString) {
        const date = new Date(dateString);

        // Convert to IST (UTC+5:30)
        const istOffset = 5.5 * 60 * 60000; // in milliseconds
        const istDate = new Date(date.getTime() + istOffset);

        const day = String(istDate.getUTCDate()).padStart(2, "0");
        const month = String(istDate.getUTCMonth() + 1).padStart(2, "0"); // Months are 0-based
        const year = istDate.getUTCFullYear();

        return `${day}/${month}/${year}`;
      }

      function deleteIssue(event) {
        const button = event.target;
        const issue_id = button.getAttribute("data-is-id");

        if (!confirm("Are you sure you want to delete this issue")) return;

        authFetch(`/api/data/issues/${issue_id}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to delete issue.");
            button.closest("tr")?.remove();
          })
          .catch((err) => {
            console.error(err);
            alert("Error deleting issue.");
          });
      }

      function deleteStateWiseData(event, swd_id) {
        if (!confirm('Are you sure you want to delete this row?')) return;
        authFetch(`/api/data/state-wise-data/${swd_id}`, { method: 'DELETE' })
          .then(res => {
            if (!res.ok) throw new Error('Failed to delete');
            event.target.closest('tr').remove();
          })
          .catch(err => {
            console.error(err);
            alert('Error deleting row');
          });
      }
    </script>

    <!-- Edit State-wise Data Modal -->
    <div class="modal fade" id="editStateWiseModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit State-wise Data</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editStateWiseForm">
              <input type="hidden" id="editSwd_id" />
              <div class="mb-3">
                <label for="editName" class="form-label">Name</label>
                <input type="text" class="form-control" id="editName" required />
              </div>
              <div class="mb-3">
                <label for="editPsaMw" class="form-label">PSA Signed (MW)</label>
                <input type="number" step="0.01" class="form-control" id="editPsaMw" />
              </div>
              <div class="mb-3">
                <label for="editCommissionedMw" class="form-label">Commissioned (MW)</label>
                <input type="number" step="0.01" class="form-control" id="editCommissionedMw" />
              </div>
              <div class="mb-3">
                <label class="form-label">Regulations / Policy Files</label>
                <div id="regulationsPoliciesList" class="mb-2"></div>
                <input type="file" class="form-control" id="editRegulationsFile" accept=".pdf,.doc,.docx,.txt" multiple />
                <small class="form-text text-muted">Add additional regulation/policy files</small>
              </div>
              <div class="mb-3">
                <label class="form-label">Report Files</label>
                <div id="reportFilesList" class="mb-2"></div>
                <input type="file" class="form-control" id="editReportFile" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.png" multiple />
                <small class="form-text text-muted">Add additional report files</small>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveEditStateWiseData()">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/0.8.0/Sortable.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Edit Modal Functions
      let editModalInstance = null;
      let currentEditData = null;

      function editStateWiseData(swd_id) {
        // Fetch the current data for this item
        const row = event.target.closest('tr');
        const cells = row.querySelectorAll('td');
        
        currentEditData = {
          swd_id: swd_id,
          name: cells[1].textContent,
          psa_signed_mw: cells[2].textContent,
          commissioned_mw: cells[3].textContent
        };

        // Populate the form
        document.getElementById('editSwd_id').value = swd_id;
        document.getElementById('editName').value = currentEditData.name;
        document.getElementById('editPsaMw').value = currentEditData.psa_signed_mw === '-' ? '' : currentEditData.psa_signed_mw;
        document.getElementById('editCommissionedMw').value = currentEditData.commissioned_mw === '-' ? '' : currentEditData.commissioned_mw;

        // Load existing files
        loadExistingFiles(swd_id);

        // Show modal
        editModalInstance = new bootstrap.Modal(document.getElementById('editStateWiseModal'));
        editModalInstance.show();
      }

      function loadExistingFiles(swd_id) {
        // This would need to fetch the actual file list from the backend
        // For now, we'll clear the lists
        document.getElementById('regulationsPoliciesList').innerHTML = '<p class="text-muted">No files to display</p>';
        document.getElementById('reportFilesList').innerHTML = '<p class="text-muted">No files to display</p>';
      }

      function saveEditStateWiseData() {
        const swd_id = document.getElementById('editSwd_id').value;
        const name = document.getElementById('editName').value;
        const psa_signed_mw = document.getElementById('editPsaMw').value;
        const commissioned_mw = document.getElementById('editCommissionedMw').value;

        const updateData = {
          name,
          psa_signed_mw: psa_signed_mw ? parseFloat(psa_signed_mw) : null,
          commissioned_mw: commissioned_mw ? parseFloat(commissioned_mw) : null
        };

        authFetch(`/api/data/state-wise-data/${swd_id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData)
        })
          .then(res => {
            if (!res.ok) throw new Error('Failed to update');
            editModalInstance.hide();
            alert('State-wise data updated successfully!');
            location.reload(); // Reload to show updated data
          })
          .catch(err => {
            console.error(err);
            alert('Error updating state-wise data');
          });
      }
    </script>
  </body>
</html>
