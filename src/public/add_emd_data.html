<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Correspondences</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 30px 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      .container-main { 
        max-width: 1000px;
        margin: auto;
      }
      .header-section {
        background: #fff;
        padding: 40px 30px;
        border-radius: 16px;
        margin-bottom: 32px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
      }
      .header-section h2 {
        color: #2d3748;
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
        letter-spacing: -0.5px;
      }
      .header-section h4 {
        color: #333;
        font-weight: 600;
        margin: 0;
      }
      .header-section h5 {
        color: #666;
        font-size: 1rem;
        font-weight: 400;
        margin: 5px 0 0 0;
      }
      .back-btn-container {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 20px;
      }
      .back-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 10px 18px;
        border-radius: 8px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.3s ease;
        white-space: nowrap;
      }
      .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        color: white;
      }
      .form-container {
        max-width: 900px;
        margin: auto;
        background: #fff;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
      }
      form {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px 30px;
      }
      .form-section {
        grid-column: span 2;
        margin-top: 10px;
        margin-bottom: 5px;
        padding-bottom: 8px;
        border-bottom: 3px solid #667eea;
        color: #2d3748;
        font-weight: 700;
        font-size: 16px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .form-group {
        margin-bottom: 24px;
        display: flex;
        flex-direction: column;
      }
      label {
        font-weight: 600;
        font-size: 14px;
        color: #2d3748;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
      }
      .required::after {
        content: " *";
        color: #dc3545;
      }
      .form-control {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #f8fafc;
        color: #2d3748;
        margin-bottom: 4px;
        box-shadow: none;
      }
      .form-control:focus {
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
      }
      textarea.form-control {
        resize: vertical;
      }
      .btn-success {
        background-color: #1976d2;
        border-color: #1976d2;
        font-weight: 600;
        padding: 10px 24px;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }
      .btn-success:hover {
        background-color: #1565c0;
        border-color: #1565c0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(25, 118, 210, 0.15);
      }
      @media (max-width: 768px) {
        .form-container {
          padding: 18px 8px;
        }
        form {
          grid-template-columns: 1fr;
        }
        .form-section {
          font-size: 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container-main">
      <div class="back-btn-container">
        <a href="/home.html" class="back-btn">‚Üê Back to Home</a>
      </div>

      <div class="header-section">
      //This page is intentionally left blank to remove Energy Management Data page. -->
        <h4 id="statisticTitle" class="mb-1"></h4>
        <h5 id="entityTitle" class="text-muted"></h5>
      </div>

      <div class="tabs-container">
        <div class="form-container mt-4 mb-4">
          <form id="energy-management-form">
            <div class="form-section">Date & Duration</div>
            <div class="form-group">
              <label for="date" class="required">Date</label>
              <input type="date" id="date" name="date" required class="form-control" />
            </div>
            <div class="form-group">
              <label for="days">Days (Auto-calculated)</label>
              <input type="number" id="days" name="days" readonly class="form-control" />
            </div>
            <div class="form-section">State-wise Data</div>
            <div class="form-group">
              <label for="discom_name" class="required">Discom Name</label>
              <input type="text" id="discom_name" name="discom_name" required class="form-control" />
            </div>
            <div class="form-group">
              <label for="state" class="required">State</label>
              <select id="state" name="state" required class="form-control">
                <option value="">Select State</option>
                <option value="Andhra Pradesh">Andhra Pradesh</option>
                <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                <option value="Assam">Assam</option>
                <option value="Bihar">Bihar</option>
                <option value="Chhattisgarh">Chhattisgarh</option>
                <option value="Goa">Goa</option>
                <option value="Gujarat">Gujarat</option>
                <option value="Haryana">Haryana</option>
                <option value="Himachal Pradesh">Himachal Pradesh</option>
                <option value="Jharkhand">Jharkhand</option>
                <option value="Karnataka">Karnataka</option>
                <option value="Kerala">Kerala</option>
                <option value="Madhya Pradesh">Madhya Pradesh</option>
                <option value="Maharashtra">Maharashtra</option>
                <option value="Manipur">Manipur</option>
                <option value="Meghalaya">Meghalaya</option>
                <option value="Mizoram">Mizoram</option>
                <option value="Nagaland">Nagaland</option>
                <option value="Odisha">Odisha</option>
                <option value="Punjab">Punjab</option>
                <option value="Rajasthan">Rajasthan</option>
                <option value="Sikkim">Sikkim</option>
                <option value="Tamil Nadu">Tamil Nadu</option>
                <option value="Telangana">Telangana</option>
                <option value="Tripura">Tripura</option>
                <option value="Uttar Pradesh">Uttar Pradesh</option>
                <option value="Uttarakhand">Uttarakhand</option>
                <option value="West Bengal">West Bengal</option>
              </select>
            </div>
            <div class="form-section">Energy Metrics</div>
            <div class="form-group">
              <label for="energy_generated" class="required">Energy Generated (MWh)</label>
              <input type="number" id="energy_generated" name="energy_generated" required class="form-control" />
            </div>
            <div class="form-group">
              <label for="energy_imported">Energy Imported (MWh)</label>
              <input type="number" id="energy_imported" name="energy_imported" class="form-control" />
            </div>
            <div class="form-group">
              <label for="energy_exported">Energy Exported (MWh)</label>
              <input type="number" id="energy_exported" name="energy_exported" class="form-control" />
            </div>
            <div class="form-section">Remarks</div>
            <div class="form-group">
              <label for="remarks">Remarks</label>
              <textarea id="remarks" name="remarks" rows="2" class="form-control"></textarea>
            </div>
            <div class="form-group" style="grid-column: span 2; margin-top: 20px;">
              <button type="submit" class="btn btn-success">Submit</button>
            </div>
          </form>
        </div>
        <ul class="nav nav-tabs" id="dynamicTabs" role="tablist"></ul>
        <div class="tab-content" id="dynamicTabContent"></div>
      </div>
    </div>

    <script src="./js/main.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);
        const dept_id = params.get("dept_id");
        const statistic_id = params.get("statistic_id");
        const entity_id = params.get("entity_id");
        const statisticDropdown = document.getElementById("statisticDropdown");

        Promise.all([
          authFetch(`/api/data/statistics/${dept_id}`),
          authFetch(`/api/data/entities/${dept_id}/${statistic_id}`),
        ])
          .then(([statsRes, entitiesRes]) =>
            Promise.all([statsRes.json(), entitiesRes.json()])
          )
          .then(([stats, entities]) => {
            const stat = stats.find((s) => s.statistic_id == statistic_id);
            const entity = entities.find((e) => e.entity_id == entity_id);

            document.getElementById("statisticTitle").innerText =
              stat?.statistic_name || "Statistic";
            document.getElementById("entityTitle").innerText =
              entity?.entity_name || "Entity";

            loadTabsForStatistic(statistic_id, entity_id);
          });

        statisticDropdown.addEventListener("change", (e) => {
          loadTabsForStatistic(e.target.value);
        });

        function loadTabsForStatistic(statistic_id) {
          authFetch(
            `/api/data/documents/grouped/${dept_id}/${statistic_id}/${entity_id}`
          )
            .then((res) => res.json())
            .then((data) => {
              console.log(data);
              populateTabs(data, dept_id, statistic_id, entity_id);
            });
        }

        function populateTabs(data, dept_id, statistic_id, entity_id) {
          const tabList = document.getElementById("dynamicTabs");
          const tabContent = document.getElementById("dynamicTabContent");

          tabList.innerHTML = "";
          tabContent.innerHTML = "";

          const types = [
            { id: "dp", label: "Developer Payment", source: "documents" },
            { id: "sp", label: "Sale and Purchase", source: "documents" },
            { id: "discom", label: "DISCOM Payment and Outstanding Dues", source: "documents" },
            { id: "ro", label: "Regulatory Order", source: "documents" },
            { id: "swd", label: "State-wise Data", source: "stateWiseData" },
          ];

          types.forEach((type, index) => {
            const tabId = `tab-${type.id}`;
            const isActive = index === 0 ? "active" : "";
            const isShow = index === 0 ? "show active" : "";

            const tabButton = document.createElement("li");
            tabButton.className = "nav-item";
            tabButton.innerHTML = `
      <button class="nav-link ${isActive}" id="${tabId}-tab" data-bs-toggle="tab" data-bs-target="#${tabId}" type="button" role="tab">
        ${type.label}
      </button>`;
            tabList.appendChild(tabButton);

            const pane = document.createElement("div");
            pane.className = `tab-pane fade ${isShow}`;
            pane.id = tabId;
            pane.role = "tabpanel";

            let items = [];
            if (type.source === "documents") {
              items = (data.documents || []).filter((doc) => {
                const typeMatch = type.docTypes
                  ? type.docTypes.includes(doc.doc_type)
                  : doc.doc_type === type.id;
                return (
                  typeMatch &&
                  doc.statistic_id == statistic_id &&
                  doc.entity_id == entity_id
                );
              });
            } else if (type.source === "correspondences") {
              items = (data.correspondences || []).filter(
                (c) =>
                  c.correspondence_type === type.filter &&
                  c.statistic_id == statistic_id &&
                  c.entity_id == entity_id
              );
            } else if (type.source === "issues") {
              items = (data.issues || []).filter(
                (issue) =>
                  issue.statistic_id == statistic_id &&
                  issue.entity_id == entity_id
              );
            } else if (type.source === "stateWiseData") {
              items = (data.stateWiseData || []).filter(
                (swd) =>
                  swd.statistic_id == statistic_id &&
                  swd.entity_id == entity_id
              );
            }

            // Add "+ Add ..." button
            const addButton = document.createElement("button");
            addButton.className = "btn btn-sm btn-success mb-2";
            addButton.innerText = `+ Add ${type.label}`;
            addButton.onclick = () => {
              if (type.source === "documents") {
                const docType = type.docTypeForAdd || (type.docTypes && type.docTypes[0]) || type.id;
                const title = encodeURIComponent(type.titleForAdd || type.label);
                window.location.href = `/emd_document.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}&doc_type=${docType}&title=${title}`;
              } else if (type.id === "dpr") {
                window.location.href = `/add_dpr.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else if (type.id === "mpr") {
                window.location.href = `/add_mpr.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else if (type.id === "cc") {
                window.location.href = `/add_correspondence_contractor.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else if (type.id === "sc") {
                window.location.href = `/add_correspondence_other.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else if (type.id === "is") {
                window.location.href = `/add_issues.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else if (type.id === "swd") {
                window.location.href = `/add_state_wise_data.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else {
                alert("Coming Soon...");
              }
            };

            pane.appendChild(addButton);

            // Add the data table
            const table = buildDocumentTable(items, type);
            table.className = "table table-bordered";
            pane.appendChild(table);
            tabContent.appendChild(pane);
          });
        }

        function buildDocumentTable(items, type) {
          const table = document.createElement("table");
          table.className = "table table-bordered";
          const thead = document.createElement("thead");
          const tbody = document.createElement("tbody");

          let columns = "";
          if (type.id === "is" || type.source === "issues") {
            columns = `
            <tr>
              <th class="sortable">S. No.</th>
              <th class="sortable">Issue Description</th>
              <th class="sortable">Issue Pertaining To</th>
              <th class="sortable">Issue Date</th>
              <th>View Issue Document</th>
              <th class="sortable">Uploaded On</th>
              <th>action</th>
            </tr>`;
          } else if (type.id === "swd") {
            columns = `
              <tr>
              <th class="sortable">S. No.</th>
              <th class="sortable">Name</th>
              <th class="sortable">PSA Signed (MW)</th>
              <th class="sortable">Commissioned (MW)</th>
              <th class="sortable">Regulations / Policy</th>
              <th class="sortable">Report</th>
              </tr>`;
          } else if (type.source === "documents") {
            columns = `
              <tr>
              <th class="sortable">S. No.</th>
              <th class="sortable">Document Name</th>
              <th class="sortable">Dated</th>
              <th>View Document</th>
              <th class="sortable">Uploaded On</th>
              <th></th>
              </tr>`;
          } else {
            columns = `
              <tr>
  <th class="sortable">S. No.</th>
  <th class="sortable">Subject</th>
  <th class="sortable">Dated</th>
  <th class="sortable">From</th>
  <th class="sortable">To</th>
  <th class="sortable">Uploaded On</th>
  <th>View</th>
  <th></th>
</tr>
            `;
          }

          thead.innerHTML = columns;

          let index = 1;
          items.forEach((item) => {
            const tr = document.createElement("tr");

            if (type.id === "is" || type.source === "issues") {
              tr.innerHTML = `
              <td>${index}</td>
              <td>${item.issue_description}</td>
              <td>${item.issue_pertaining_to}</td>
<td data-sort-value="${item.issue_date}">
  ${formatToISTDate(item.issue_date)}
</td>              <td>
                ${
                  item.issue_doc_path
                    ? `<a href="${item.issue_doc_path}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>`
                    : `<button class="btn btn-sm btn-secondary" disabled>No Document</button>`
                }
              </td>
<td data-sort-value="${item.createdAt}">
  ${formatToISTDate(item.createdAt)}
</td>              <td><button class="btn btn-danger btn-sm" data-is-id="${
                item.issue_id
              }" onclick="deleteIssue(event)">Delete</button></td>`;
            } else if (type.id === "swd") {
              tr.innerHTML = `
                <td>${index}</td>
                <td>${item.name}</td>
                <td>${(item.psa_signed_mw !== undefined && item.psa_signed_mw !== null) ? parseFloat(item.psa_signed_mw).toFixed(2) : '-'}</td>
                <td>${(item.commissioned_mw !== undefined && item.commissioned_mw !== null) ? parseFloat(item.commissioned_mw).toFixed(2) : '-'}</td>
                <td>
                  ${
                    Array.isArray(item.regulations_policy) && item.regulations_policy.length > 0
                      ? item.regulations_policy.map((url, idx) => `<a href="${url}" target="_blank" class="btn btn-sm btn-outline-primary mb-1">View ${idx+1}</a>`).join(' ')
                      : (item.regulations_policy ? `<a href="${item.regulations_policy}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>` : `<button class="btn btn-sm btn-secondary" disabled>No Policy</button>`)
                  }
                </td>
                <td>
                  ${
                    item.report_path
                      ? `<a href="${item.report_path}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>`
                      : `<button class="btn btn-sm btn-secondary" disabled>No Report</button>`
                  }
                </td>`;
            } else if (type.source === "documents") {
              tr.innerHTML = `
              <td>${index}</td>
              <td>${item.doc_name}</td>
              <td data-sort-value="${item.doc_date}">
  ${formatToISTDate(item.doc_date)}
</td>



              <td><a href="{
                item.doc_path
              }" target="_blank" class="btn btn-sm btn-outline-primary">View</a></td>
<td data-sort-value="${item.createdAt}">
  ${formatToISTDate(item.createdAt)}
</td>              <td><button class="btn btn-danger btn-sm" data-doc-id="${
                item.doc_id
              }" onclick="deleteDocument(event)">Delete</button></td>`;
            } else {
              tr.innerHTML = `
        <td>${index}</td>
        <td>${item.subject || ""}</td>
<td data-sort-value="${item.correspondence_date}">
  ${formatToISTDate(item.correspondence_date)}
</td>        <td>${item.from || ""}</td>
        <td>${item.to || ""}</td>
<td data-sort-value="${item.createdAt}">
  ${formatToISTDate(item.createdAt)}
</td>        <td><a href="${
                item.doc_path
              }" target="_blank" class="btn btn-sm btn-outline-primary">View</a></td>
        <td><button class="btn btn-danger btn-sm" data-corr-id="${
          item.correspondence_id
        }" onclick="deleteCorrespondence(event)">Delete</button></td>`;
            }

            tbody.appendChild(tr);
            index++;
          });

          table.appendChild(thead);
          table.appendChild(tbody);
          return table;
        }
      });

      function authFetch(url, options = {}) {
        const token = localStorage.getItem("token");
        const defaultHeaders = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        };

        return fetch(url, {
          ...options,
          headers: {
            ...defaultHeaders,
            ...(options.headers || {}),
          },
        }).then((res) => {
          if (res.status === 401) {
            alert("Session expired. Redirecting to login...");
            localStorage.clear();
            window.location.href = "/";
            throw new Error("Unauthorized");
          }
          return res;
        });
      }

      function formatToISTDate(dateString) {
        const date = new Date(dateString);

        // Convert to IST (UTC+5:30)
        const istOffset = 5.5 * 60 * 60000; // in milliseconds
        const istDate = new Date(date.getTime() + istOffset);

        const day = String(istDate.getUTCDate()).padStart(2, "0");
        const month = String(istDate.getUTCMonth() + 1).padStart(2, "0"); // Months are 0-based
        const year = istDate.getUTCFullYear();

        return `${day}/${month}/${year}`;
      }

      function deleteIssue(event) {
        const button = event.target;
        const issue_id = button.getAttribute("data-is-id");

        if (!confirm("Are you sure you want to delete this issue")) return;

        authFetch(`/api/data/issues/${issue_id}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to delete issue.");
            button.closest("tr")?.remove();
          })
          .catch((err) => {
            console.error(err);
            alert("Error deleting issue.");
          });
      }

      function deleteCorrespondence(event) {
        const button = event.target;
        const correspondence_id = button.getAttribute("data-corr-id");

        console.log(correspondence_id);

        if (!confirm("Are you sure you want to delete this correspondence?"))
          return;

        authFetch(`/api/data/correspondences/${correspondence_id}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to delete document.");
            button.closest("tr")?.remove();
          })
          .catch((err) => {
            console.error(err);
            alert("Error deleting document.");
          });
      }

      function deleteDocument(event) {
        const button = event.target;
        const doc_id = button.getAttribute("data-doc-id");

        if (!confirm("Are you sure you want to delete this document?")) return;

        authFetch(`/api/data/documents/${doc_id}`, {
          method: "DELETE",
        })
          .then((res) => { 
            if (!res.ok) throw new Error("Failed to delete document.");
            button.closest("tr")?.remove();
          }) 
          .catch((err) => {
            console.error(err);
            alert("Error deleting document.");
          });
      }

      function deleteStateWiseData(event) {
        const button = event.target;
        const swd_id = button.getAttribute("data-swd-id");

        if (!confirm("Are you sure you want to delete this state-wise data?")) return;

        authFetch(`/api/data/state-wise-data/${swd_id}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to delete state-wise data.");
            button.closest("tr")?.remove();
          })
          .catch((err) => {
            console.error(err);
            alert("Error deleting state-wise data.");
          });
      }
    </script>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/0.8.0/Sortable.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>