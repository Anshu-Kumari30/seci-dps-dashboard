<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Correspondences</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 40px 20px;
      }

      .container-main {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header-section {
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .header-section h2 {
        color: #667eea;
        margin: 0 0 10px 0;
        font-weight: 700;
      }

      .header-section h4 {
        color: #333;
        font-weight: 600;
        margin: 0;
      }

      .header-section h5 {
        color: #666;
        font-size: 0.95rem;
        font-weight: 400;
        margin: 5px 0 0 0;
      }

      .back-btn-container {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 20px;
      }

      .back-btn {
        background-color: #667eea;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .back-btn:hover {
        background-color: #764ba2;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .tabs-container {
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .nav-tabs {
        border-bottom: 2px solid #e0e0e0;
        flex-wrap: wrap;
      }

      .nav-tabs .nav-link {
        color: #666;
        font-weight: 600;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 12px 20px;
        margin-right: 5px;
        border-radius: 8px 8px 0 0;
        transition: all 0.3s ease;
      }

      .nav-tabs .nav-link:hover {
        color: #667eea;
        background-color: #f5f5f5;
      }

      .nav-tabs .nav-link.active {
        color: #667eea;
        background-color: transparent;
        border-bottom-color: #667eea;
      }

      .tab-content {
        margin-top: 20px;
        background: white;
        padding: 20px;
        border-radius: 8px;
      }

      .btn-success {
        background-color: #48bb78;
        border-color: #48bb78;
        font-weight: 600;
        padding: 8px 16px;
        border-radius: 6px;
        transition: all 0.3s ease;
      }

      .btn-success:hover {
        background-color: #38a169;
        border-color: #38a169;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
      }

      .table {
        margin-top: 20px;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 8px;
        overflow: hidden;
      }

      .table thead {
        background-color: #667eea;
        color: white;
      }

      .table thead th {
        border: none;
        font-weight: 600;
        padding: 15px;
        text-align: left;
      }

      .table tbody tr {
        border-bottom: 1px solid #e0e0e0;
        transition: all 0.2s ease;
      }

      .table tbody tr:hover {
        background-color: #f9f9f9;
      }

      .table tbody td {
        padding: 12px 15px;
        vertical-align: middle;
      }

      .btn-danger {
        background-color: #f56565;
        border-color: #f56565;
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 6px;
        transition: all 0.3s ease;
      }

      .btn-danger:hover {
        background-color: #e53e3e;
        border-color: #e53e3e;
        transform: translateY(-2px);
      }

      .btn-outline-primary {
        color: #667eea;
        border-color: #667eea;
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 6px;
        transition: all 0.3s ease;
      }

      .btn-outline-primary:hover {
        background-color: #667eea;
        border-color: #667eea;
        color: white;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }

      .empty-state p {
        font-size: 1.1rem;
        margin: 0;
      }

      @media (max-width: 768px) {
        .nav-tabs {
          flex-wrap: wrap;
        }

        .nav-tabs .nav-link {
          padding: 10px 15px;
          font-size: 0.9rem;
        }

        .header-section {
          padding: 20px;
        }

        .tabs-container {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container-main">
      <div class="back-btn-container">
        <a href="/home.html" class="back-btn">‚Üê Back to Home</a>
      </div>

      <div class="header-section">
        <h2>Energy Management Data</h2>
        <h4 id="statisticTitle" class="mb-1"></h4>
        <h5 id="entityTitle" class="text-muted"></h5>
      </div>

      <div class="tabs-container">
        <ul class="nav nav-tabs" id="dynamicTabs" role="tablist"></ul>
        <div class="tab-content" id="dynamicTabContent"></div>
      </div>
    </div>

    <script src="./js/main.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);
        const dept_id = params.get("dept_id");
        const statistic_id = params.get("statistic_id");
        const entity_id = params.get("entity_id");
        const statisticDropdown = document.getElementById("statisticDropdown");

        Promise.all([
          authFetch(`/api/data/statistics/${dept_id}`),
          authFetch(`/api/data/entities/${dept_id}/${statistic_id}`),
        ])
          .then(([statsRes, entitiesRes]) =>
            Promise.all([statsRes.json(), entitiesRes.json()])
          )
          .then(([stats, entities]) => {
            const stat = stats.find((s) => s.statistic_id == statistic_id);
            const entity = entities.find((e) => e.entity_id == entity_id);

            document.getElementById("statisticTitle").innerText =
              stat?.statistic_name || "Statistic";
            document.getElementById("entityTitle").innerText =
              entity?.entity_name || "Entity";

            loadTabsForStatistic(statistic_id, entity_id);
          });

        statisticDropdown.addEventListener("change", (e) => {
          loadTabsForStatistic(e.target.value);
        });

        function loadTabsForStatistic(statistic_id) {
          authFetch(
            `/api/data/documents/grouped/${dept_id}/${statistic_id}/${entity_id}`
          )
            .then((res) => res.json())
            .then((data) => {
              console.log(data);
              populateTabs(data, dept_id, statistic_id, entity_id);
            });
        }

        function populateTabs(data, dept_id, statistic_id, entity_id) {
          const tabList = document.getElementById("dynamicTabs");
          const tabContent = document.getElementById("dynamicTabContent");

          tabList.innerHTML = "";
          tabContent.innerHTML = "";

          const types = [
            { id: "dp", label: "Developer Payment", source: "documents" },
            { id: "sp", label: "Sale and Purchase", source: "documents" },
            { id: "discom", label: "DISCOM Payment and Outstanding Dues", source: "documents" },
            { id: "ro", label: "Regulatory Order", source: "documents" },
            { id: "swd", label: "State-wise Data", source: "stateWiseData" },
          ];

          types.forEach((type, index) => {
            const tabId = `tab-${type.id}`;
            const isActive = index === 0 ? "active" : "";
            const isShow = index === 0 ? "show active" : "";

            const tabButton = document.createElement("li");
            tabButton.className = "nav-item";
            tabButton.innerHTML = `
      <button class="nav-link ${isActive}" id="${tabId}-tab" data-bs-toggle="tab" data-bs-target="#${tabId}" type="button" role="tab">
        ${type.label}
      </button>`;
            tabList.appendChild(tabButton);

            const pane = document.createElement("div");
            pane.className = `tab-pane fade ${isShow}`;
            pane.id = tabId;
            pane.role = "tabpanel";

            let items = [];
            if (type.source === "documents") {
              items = (data.documents || []).filter((doc) => {
                const typeMatch = type.docTypes
                  ? type.docTypes.includes(doc.doc_type)
                  : doc.doc_type === type.id;
                return (
                  typeMatch &&
                  doc.statistic_id == statistic_id &&
                  doc.entity_id == entity_id
                );
              });
            } else if (type.source === "correspondences") {
              items = (data.correspondences || []).filter(
                (c) =>
                  c.correspondence_type === type.filter &&
                  c.statistic_id == statistic_id &&
                  c.entity_id == entity_id
              );
            } else if (type.source === "issues") {
              items = (data.issues || []).filter(
                (issue) =>
                  issue.statistic_id == statistic_id &&
                  issue.entity_id == entity_id
              );
            } else if (type.source === "stateWiseData") {
              items = (data.stateWiseData || []).filter(
                (swd) =>
                  swd.statistic_id == statistic_id &&
                  swd.entity_id == entity_id
              );
            }

            // Add "+ Add ..." button
            const addButton = document.createElement("button");
            addButton.className = "btn btn-sm btn-success mb-2";
            addButton.innerText = `+ Add ${type.label}`;
            addButton.onclick = () => {
              if (type.source === "documents") {
                const docType = type.docTypeForAdd || (type.docTypes && type.docTypes[0]) || type.id;
                const title = encodeURIComponent(type.titleForAdd || type.label);
                window.location.href = `/add_contract_document.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}&doc_type=${docType}&title=${title}`;
              } else if (type.id === "dpr") {
                window.location.href = `/add_dpr.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else if (type.id === "mpr") {
                window.location.href = `/add_mpr.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else if (type.id === "cc") {
                window.location.href = `/add_correspondence_contractor.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else if (type.id === "sc") {
                window.location.href = `/add_correspondence_other.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else if (type.id === "is") {
                window.location.href = `/add_issues.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else if (type.id === "swd") {
                window.location.href = `/add_state_wise_data.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
              } else {
                alert("Coming Soon...");
              }
            };

            pane.appendChild(addButton);

            // Add the data table
            const table = buildDocumentTable(items, type);
            table.className = "table table-bordered";
            pane.appendChild(table);
            tabContent.appendChild(pane);
          });
        }

        function buildDocumentTable(items, type) {
          const table = document.createElement("table");
          table.className = "table table-bordered";
          const thead = document.createElement("thead");
          const tbody = document.createElement("tbody");

          let columns = "";
          if (type.id === "is" || type.source === "issues") {
            columns = `
            <tr>
              <th class="sortable">S. No.</th>
              <th class="sortable">Issue Description</th>
              <th class="sortable">Issue Pertaining To</th>
              <th class="sortable">Issue Date</th>
              <th>View Issue Document</th>
              <th class="sortable">Uploaded On</th>
              <th>action</th>
            </tr>`;
          } else if (type.id === "swd") {
            columns = `
              <tr>
              <th class="sortable">S. No.</th>
              <th class="sortable">Name</th>
              <th class="sortable">PSA Signed (MW)</th>
              <th class="sortable">Commissioned (MW)</th>
              <th class="sortable">Regulations / Policy</th>
              <th class="sortable">Report</th>
              </tr>`;
          } else if (type.source === "documents") {
            columns = `
              <tr>
              <th class="sortable">S. No.</th>
              <th class="sortable">Document Name</th>
              <th class="sortable">Dated</th>
              <th>View Document</th>
              <th class="sortable">Uploaded On</th>
              <th></th>
              </tr>`;
          } else {
            columns = `
              <tr>
  <th class="sortable">S. No.</th>
  <th class="sortable">Subject</th>
  <th class="sortable">Dated</th>
  <th class="sortable">From</th>
  <th class="sortable">To</th>
  <th class="sortable">Uploaded On</th>
  <th>View</th>
  <th></th>
</tr>
            `;
          }

          thead.innerHTML = columns;

          let index = 1;
          items.forEach((item) => {
            const tr = document.createElement("tr");

            if (type.id === "is" || type.source === "issues") {
              tr.innerHTML = `
              <td>${index}</td>
              <td>${item.issue_description}</td>
              <td>${item.issue_pertaining_to}</td>
<td data-sort-value="${item.issue_date}">
  ${formatToISTDate(item.issue_date)}
</td>              <td>
                ${
                  item.issue_doc_path
                    ? `<a href="${item.issue_doc_path}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>`
                    : `<button class="btn btn-sm btn-secondary" disabled>No Document</button>`
                }
              </td>
<td data-sort-value="${item.createdAt}">
  ${formatToISTDate(item.createdAt)}
</td>              <td><button class="btn btn-danger btn-sm" data-is-id="${
                item.issue_id
              }" onclick="deleteIssue(event)">Delete</button></td>`;
            } else if (type.id === "swd") {
              tr.innerHTML = `
              <td>${index}</td>
              <td>${item.name}</td>
              <td>${(item.psa_signed_mw !== undefined && item.psa_signed_mw !== null) ? parseFloat(item.psa_signed_mw).toFixed(2) : '-'}</td>
              <td>${(item.commissioned_mw !== undefined && item.commissioned_mw !== null) ? parseFloat(item.commissioned_mw).toFixed(2) : '-'}</td>
              <td>${item.regulations_policy || '-'}</td>
              <td>$
                ${
                  item.report_path
                    ? `<a href="${item.report_path}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>`
                    : `<button class="btn btn-sm btn-secondary" disabled>No Report</button>`
                }
              </td>`;
            } else if (type.source === "documents") {
              tr.innerHTML = `
              <td>${index}</td>
              <td>${item.doc_name}</td>
              <td data-sort-value="${item.doc_date}">
  ${formatToISTDate(item.doc_date)}
</td>

              <td><a href="${
                item.doc_path
              }" target="_blank" class="btn btn-sm btn-outline-primary">View</a></td>
<td data-sort-value="${item.createdAt}">
  ${formatToISTDate(item.createdAt)}
</td>              <td><button class="btn btn-danger btn-sm" data-doc-id="${
                item.doc_id
              }" onclick="deleteDocument(event)">Delete</button></td>`;
            } else {
              tr.innerHTML = `
        <td>${index}</td>
        <td>${item.subject || ""}</td>
<td data-sort-value="${item.correspondence_date}">
  ${formatToISTDate(item.correspondence_date)}
</td>        <td>${item.from || ""}</td>
        <td>${item.to || ""}</td>
<td data-sort-value="${item.createdAt}">
  ${formatToISTDate(item.createdAt)}
</td>        <td><a href="${
                item.doc_path
              }" target="_blank" class="btn btn-sm btn-outline-primary">View</a></td>
        <td><button class="btn btn-danger btn-sm" data-corr-id="${
          item.correspondence_id
        }" onclick="deleteCorrespondence(event)">Delete</button></td>`;
            }

            tbody.appendChild(tr);
            index++;
          });

          table.appendChild(thead);
          table.appendChild(tbody);
          return table;
        }
      });

      function authFetch(url, options = {}) {
        const token = localStorage.getItem("token");
        const defaultHeaders = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        };

        return fetch(url, {
          ...options,
          headers: {
            ...defaultHeaders,
            ...(options.headers || {}),
          },
        }).then((res) => {
          if (res.status === 401) {
            alert("Session expired. Redirecting to login...");
            localStorage.clear();
            window.location.href = "/";
            throw new Error("Unauthorized");
          }
          return res;
        });
      }

      function formatToISTDate(dateString) {
        const date = new Date(dateString);

        // Convert to IST (UTC+5:30)
        const istOffset = 5.5 * 60 * 60000; // in milliseconds
        const istDate = new Date(date.getTime() + istOffset);

        const day = String(istDate.getUTCDate()).padStart(2, "0");
        const month = String(istDate.getUTCMonth() + 1).padStart(2, "0"); // Months are 0-based
        const year = istDate.getUTCFullYear();

        return `${day}/${month}/${year}`;
      }

      function deleteIssue(event) {
        const button = event.target;
        const issue_id = button.getAttribute("data-is-id");

        if (!confirm("Are you sure you want to delete this issue")) return;

        authFetch(`/api/data/issues/${issue_id}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to delete issue.");
            button.closest("tr")?.remove();
          })
          .catch((err) => {
            console.error(err);
            alert("Error deleting issue.");
          });
      }

      function deleteCorrespondence(event) {
        const button = event.target;
        const correspondence_id = button.getAttribute("data-corr-id");

        console.log(correspondence_id);

        if (!confirm("Are you sure you want to delete this correspondence?"))
          return;

        authFetch(`/api/data/correspondences/${correspondence_id}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to delete document.");
            button.closest("tr")?.remove();
          })
          .catch((err) => {
            console.error(err);
            alert("Error deleting document.");
          });
      }

      function deleteDocument(event) {
        const button = event.target;
        const doc_id = button.getAttribute("data-doc-id");

        if (!confirm("Are you sure you want to delete this document?")) return;

        authFetch(`/api/data/documents/${doc_id}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to delete document.");
            button.closest("tr")?.remove();
          }) 
          .catch((err) => {
            console.error(err);
            alert("Error deleting document.");
          });
      }

      function deleteStateWiseData(event) {
        const button = event.target;
        const swd_id = button.getAttribute("data-swd-id");

        if (!confirm("Are you sure you want to delete this state-wise data?")) return;

        authFetch(`/api/data/state-wise-data/${swd_id}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to delete state-wise data.");
            button.closest("tr")?.remove();
          })
          .catch((err) => {
            console.error(err);
            alert("Error deleting state-wise data.");
          });
      }
    </script>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/0.8.0/Sortable.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
