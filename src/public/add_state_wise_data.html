<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add State-wise Data</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="mb-4">Add State-wise Data</h1>
      <form id="addStateWiseDataForm">
        <div class="mb-3">
          <label for="name" class="form-label">Name</label>
          <input
            type="text"
            class="form-control"
            id="name"
            name="name"
            placeholder="Enter state/location name"
            required
          />
        </div>
        <div class="mb-3">
          <label for="psa_signed_mw" class="form-label">PSA Signed (MW)</label>
          <input
            type="number"
            step="0.01"
            class="form-control"
            id="psa_signed_mw"
            name="psa_signed_mw"
            placeholder="Enter capacity in MW"
            required
          />
        </div>
        <div class="mb-3">
          <label for="commissioned_mw" class="form-label">Commissioned (MW)</label>
          <input
            type="number"
            step="0.01"
            class="form-control"
            id="commissioned_mw"
            name="commissioned_mw"
            placeholder="Enter capacity in MW"
            required
          />
        </div>
        <div class="mb-3">
          <label for="regulations_policy" class="form-label">Regulations / Policy</label>
          <textarea
            class="form-control"
            id="regulations_policy"
            name="regulations_policy"
            rows="4"
            placeholder="Enter relevant regulations or policies"
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="reportFile" class="form-label">Report (Optional)</label>
          <small class="form-text text-muted">
            Maximum file size allowed: <strong>50 MB</strong>.
          </small>
          <input
            type="file"
            class="form-control"
            id="reportFile"
            name="report_file"
          />
        </div>

        <input type="hidden" id="deptId" name="dept_id" />
        <input type="hidden" id="statisticId" name="statistic_id" />
        <input type="hidden" id="entityId" name="entity_id" />

        <button type="submit" class="btn btn-primary">Submit</button>
        <a href="#" id="backBtn" class="btn btn-secondary ms-2">Back</a>
      </form>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const deptId = urlParams.get("dept_id");
      const statisticId = urlParams.get("statistic_id");
      const entityId = urlParams.get("entity_id");

      document.getElementById("deptId").value = deptId;
      document.getElementById("statisticId").value = statisticId;
      document.getElementById("entityId").value = entityId;
      
      document.getElementById("backBtn").href = `/add_emd_data.html?dept_id=${deptId}&statistic_id=${statisticId}&entity_id=${entityId}`;

      function authFetch(url, options = {}) {
        const token = localStorage.getItem("token");
        const defaultHeaders = {
          Authorization: `Bearer ${token}`,
        };

        return fetch(url, {
          ...options,
          headers: {
            ...defaultHeaders,
            ...(options.headers || {}),
          },
        }).then((res) => {
          if (res.status === 401) {
            alert("Session expired. Redirecting to login...");
            localStorage.clear();
            window.location.href = "/";
            throw new Error("Unauthorized");
          }
          return res;
        });
      }

      document
        .getElementById("addStateWiseDataForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(this);
          const name = document.getElementById("name").value;
          const psa_signed_mw = document.getElementById("psa_signed_mw").value;
          const commissioned_mw = document.getElementById("commissioned_mw").value;
          const regulations_policy = document.getElementById("regulations_policy").value;

          try {
            // For now, upload report file if provided (similar to issues)
            // The file upload can be enhanced later to store files
            let report_path = null;
            const reportFile = document.getElementById("reportFile").files[0];
            
            // If file is provided, we can handle it here later
            // For now, just proceed with the data

            const response = await authFetch(
              `/api/data/state-wise-data/${deptId}/${statisticId}/${entityId}`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  name,
                  psa_signed_mw: parseFloat(psa_signed_mw),
                  commissioned_mw: parseFloat(commissioned_mw),
                  regulations_policy,
                  report_path,
                }),
              }
            );

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.message || "Failed to add state-wise data.");
            }

            alert("State-wise data added successfully!");
            window.location.href = `/add_emd_data.html?dept_id=${deptId}&statistic_id=${statisticId}&entity_id=${entityId}`;
          } catch (err) {
            console.error(err);
            alert("Error adding state-wise data: " + err.message);
          }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
