<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add State-wise Data</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 30px 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
        overflow: hidden;
      }

      .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 40px 30px;
      }

      .header-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
      }

      .header-content h1 {
        font-size: 32px;
        font-weight: 700;
        margin: 0;
        letter-spacing: -0.5px;
      }

      .back-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 10px 18px;
        border-radius: 8px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        color: white;
      }

      .card-body {
        padding: 40px;
      }

      .section-title {
        font-size: 16px;
        font-weight: 700;
        color: #2d3748;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 3px solid #667eea;
        padding-bottom: 12px;
        margin: 30px 0 20px 0;
      }

      .section-title:first-child {
        margin-top: 0;
      }

      .form-group {
        margin-bottom: 24px;
      }

      .form-label {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .form-control {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #f8fafc;
      }

      .form-control:focus {
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
      }

      .form-control::placeholder {
        color: #a0aec0;
      }

      .file-upload-wrapper {
        margin-bottom: 20px;
      }

      .file-upload-area {
        border: 3px dashed #cbd5e1;
        border-radius: 12px;
        padding: 40px 30px;
        text-align: center;
        background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .file-upload-area:hover {
        border-color: #667eea;
        background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
        transform: translateY(-2px);
      }

      .file-upload-area.dragover {
        border-color: #667eea;
        background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
      }

      .upload-icon {
        width: 50px;
        height: 50px;
        margin: 0 auto 15px;
        color: #667eea;
        opacity: 0.8;
      }

      .file-upload-area p {
        margin: 0;
        color: #2d3748;
      }

      .upload-title {
        font-weight: 600;
        font-size: 16px;
        margin: 15px 0 8px;
      }

      .upload-subtitle {
        font-size: 13px;
        color: #718096;
      }

      .file-input {
        display: none;
      }

      .file-info {
        margin-top: 12px;
        color: #667eea;
        font-weight: 500;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .file-info.error {
        color: #e53e3e;
      }

      .checkmark {
        width: 18px;
        height: 18px;
        background: #667eea;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
      }

      .form-actions {
        display: flex;
        gap: 12px;
        margin-top: 40px;
      }

      .btn-submit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 14px 40px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 15px;
        transition: all 0.3s ease;
        flex: 1;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }

      .btn-submit:active {
        transform: translateY(0);
      }

      .btn-submit:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .form-text {
        font-size: 13px;
        color: #718096;
      }

      .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .two-column {
          grid-template-columns: 1fr;
        }

        .header-wrapper {
          flex-direction: column;
          align-items: flex-start;
        }

        .card-body {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container" style="max-width: 900px;">
      <div class="card">
        <div class="card-header">
          <div class="header-wrapper">
            <div class="header-content">
              <h1>Add State-wise Data</h1>
            </div>
            <a href="#" id="backBtn" class="back-btn">← Back</a>
          </div>
        </div>
        <div class="card-body">
          <form id="addStateWiseDataForm">
            <div class="section-title">Basic Information</div>

            <div class="form-group">
              <label for="name" class="form-label">Name</label>
              <input
                type="text"
                class="form-control"
                id="name"
                name="name"
                placeholder="Enter state/location name"
                required
              />
            </div>

            <div class="section-title">Capacity Details</div>

            <div class="two-column">
              <div class="form-group">
                <label for="psa_signed_mw" class="form-label">PSA Signed (MW)</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  id="psa_signed_mw"
                  name="psa_signed_mw"
                  placeholder="0.00"
                  required
                />
              </div>
              <div class="form-group">
                <label for="commissioned_mw" class="form-label">Commissioned (MW)</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  id="commissioned_mw"
                  name="commissioned_mw"
                  placeholder="0.00"
                  required
                />
              </div>
            </div>

            <div class="section-title">Documents</div>

            <div class="form-group">
              <label for="regulationsFile" class="form-label">Regulations / Policy</label>
              <small class="form-text">PDF, DOC, DOCX allowed (Max 50 MB)</small>
              <div class="file-upload-wrapper" style="margin-top: 12px;">
                <div class="file-upload-area" id="regulationsUploadArea">
                  <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                  </svg>
                  <p class="upload-title">Upload Regulations / Policy</p>
                  <p class="upload-subtitle">Click to upload or drag and drop</p>
                  <input
                    type="file"
                    class="file-input"
                    id="regulationsFile"
                    name="regulations_file"
                    accept=".pdf,.doc,.docx,.txt"
                  />
                </div>
                <div id="regulationsFileName" class="file-info"></div>
              </div>
            </div>

            <div class="form-group">
              <label for="reportFile" class="form-label">Report (Optional)</label>
              <small class="form-text">PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, JPG, PNG (Max 50 MB)</small>
              <div class="file-upload-wrapper" style="margin-top: 12px;">
                <div class="file-upload-area" id="reportUploadArea">
                  <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                  </svg>
                  <p class="upload-title">Upload Report</p>
                  <p class="upload-subtitle">Click to upload or drag and drop</p>
                  <input
                    type="file"
                    class="file-input"
                    id="reportFile"
                    name="report_file"
                    accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.png"
                  />
                </div>
                <div id="reportFileName" class="file-info"></div>
              </div>
            </div>

            <input type="hidden" id="deptId" name="dept_id" />
            <input type="hidden" id="statisticId" name="statistic_id" />
            <input type="hidden" id="entityId" name="entity_id" />

            <div class="form-actions">
              <button type="submit" class="btn-submit" id="submitBtn">✓ Submit</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const deptId = urlParams.get("dept_id");
      const statisticId = urlParams.get("statistic_id");
      const entityId = urlParams.get("entity_id");

      document.getElementById("deptId").value = deptId;
      document.getElementById("statisticId").value = statisticId;
      document.getElementById("entityId").value = entityId;
      
      document.getElementById("backBtn").href = `/add_emd_data.html?dept_id=${deptId}&statistic_id=${statisticId}&entity_id=${entityId}`;

      // File upload handlers for both file inputs
      function setupFileUploadArea(uploadAreaId, fileInputId, fileNameId) {
        const uploadArea = document.getElementById(uploadAreaId);
        const fileInput = document.getElementById(fileInputId);
        const fileName = document.getElementById(fileNameId);

        uploadArea.addEventListener("click", () => fileInput.click());

        uploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          uploadArea.classList.add("dragover");
        });

        uploadArea.addEventListener("dragleave", () => {
          uploadArea.classList.remove("dragover");
        });

        uploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          uploadArea.classList.remove("dragover");
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            fileInput.files = files;
            updateFileName(fileInput, fileName);
          }
        });

        fileInput.addEventListener("change", () => updateFileName(fileInput, fileName));
      }

      function updateFileName(fileInput, fileNameDiv) {
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
          fileNameDiv.innerHTML = `<span class="checkmark">✓</span> ${file.name} (${sizeMB} MB)`;
          fileNameDiv.classList.remove("error");
        } else {
          fileNameDiv.textContent = "";
        }
      }

      // Setup both file upload areas
      setupFileUploadArea("regulationsUploadArea", "regulationsFile", "regulationsFileName");
      setupFileUploadArea("reportUploadArea", "reportFile", "reportFileName");

      function authFetch(url, options = {}) {
        const token = localStorage.getItem("token");
        const defaultHeaders = {
          Authorization: `Bearer ${token}`,
        };

        return fetch(url, {
          ...options,
          headers: {
            ...defaultHeaders,
            ...(options.headers || {}),
          },
        }).then((res) => {
          if (res.status === 401) {
            alert("Session expired. Redirecting to login...");
            localStorage.clear();
            window.location.href = "/";
            throw new Error("Unauthorized");
          }
          return res;
        });
      }

      document
        .getElementById("addStateWiseDataForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const submitBtn = document.getElementById("submitBtn");
          const name = document.getElementById("name").value;
          const psa_signed_mw = document.getElementById("psa_signed_mw").value;
          const commissioned_mw = document.getElementById("commissioned_mw").value;

          try {
            submitBtn.disabled = true;
            submitBtn.textContent = "⏳ Uploading...";

            // Upload files first (if provided) and get stored paths
            let regulations_path = null;
            let report_path = null;

            const regulationsFile = document.getElementById("regulationsFile").files[0];
            const reportFile = document.getElementById("reportFile").files[0];

            const uploadSingle = async (file) => {
              const fd = new FormData();
              fd.append("file", file);
              const resp = await authFetch(`/api/data/documents/upload-file`, {
                method: "POST",
                body: fd,
              });
              if (!resp.ok) throw new Error("File upload failed");
              const json = await resp.json();
              return json.path;
            };

            const uploads = [];
            if (regulationsFile) uploads.push(uploadSingle(regulationsFile).then(p => regulations_path = p));
            if (reportFile) uploads.push(uploadSingle(reportFile).then(p => report_path = p));

            await Promise.all(uploads);

            // Now post the state-wise data with paths returned from uploads
            const response = await authFetch(
              `/api/data/state-wise-data/${deptId}/${statisticId}/${entityId}`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  name,
                  psa_signed_mw: parseFloat(psa_signed_mw),
                  commissioned_mw: parseFloat(commissioned_mw),
                  regulations_policy: regulations_path,
                  report_path,
                }),
              }
            );

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.message || "Failed to add state-wise data.");
            }

            alert("State-wise data added successfully!");
            window.location.href = `/add_emd_data.html?dept_id=${deptId}&statistic_id=${statisticId}&entity_id=${entityId}`;
          } catch (err) {
            console.error(err);
            submitBtn.disabled = false;
            submitBtn.textContent = "✓ Submit";
            alert("Error adding state-wise data: " + err.message);
          }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
