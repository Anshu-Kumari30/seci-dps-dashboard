<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add State-wise Data</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #f4f6f9 0%, #e8ecf1 100%);
      padding: 20px;
      min-height: 100vh;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: #0b5ed7;
      font-weight: 700;
      font-size: 28px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .form-container {
      max-width: 1000px;
      margin: auto;
      background: #ffffff;
      padding: 35px 40px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    form {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px 30px;
    }
    .form-section {
      grid-column: span 2;
      margin-top: 10px;
      margin-bottom: 5px;
      padding-bottom: 8px;
      border-bottom: 2px solid #0b5ed7;
      color: #0b5ed7;
      font-weight: 600;
      font-size: 18px;
    }
    .form-group { display: flex; flex-direction: column; }
    label { font-weight: 600; font-size: 14px; color: #333; margin-bottom: 8px; display: flex; align-items: center; }
    .required::after { content: " *"; color: #dc3545; }
    .input-with-unit { position: relative; }
    .unit {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      color: #666; font-size: 13px; background: #f8f9fa; padding: 2px 8px; border-radius: 3px; pointer-events: none;
    }
    input, select, textarea {
      width: 100%; padding: 12px; font-size: 15px; border: 1px solid #cfd4da; border-radius: 6px; transition: all 0.3s;
      background: #f8f9fa; color: #333; margin-bottom: 4px;
    }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: #0b5ed7; box-shadow: 0 0 0 3px rgba(11, 94, 215, 0.15);
    }
    input:read-only { background-color: #f8f9fa; color: #666; cursor: not-allowed; }
    input.invalid { border-color: #dc3545; background-color: rgba(220, 53, 69, 0.05); }
    input.valid { border-color: #28a745; }
    .error-message { color: #dc3545; font-size: 12px; margin-top: 4px; display: none; }
    .full-width { grid-column: span 2; }
    .btn-group { display: flex; justify-content: center; gap: 20px; margin-top: 30px; }
    button {
      padding: 12px 32px; font-size: 15px; font-weight: 600; border: none; border-radius: 6px; cursor: pointer;
      transition: all 0.3s; min-width: 140px;
    }
    .btn-submit {
      background: linear-gradient(to right, #0b5ed7, #0a58ca); color: #fff; box-shadow: 0 4px 6px rgba(11, 94, 215, 0.2);
    }
    .btn-submit:hover {
      background: linear-gradient(to right, #0a58ca, #0950b8); box-shadow: 0 6px 12px rgba(11, 94, 215, 0.3); transform: translateY(-2px);
    }
    .btn-reset {
      background: linear-gradient(to right, #6c757d, #5c636a); color: #fff; box-shadow: 0 4px 6px rgba(108, 117, 125, 0.2);
    }
    .btn-reset:hover { background: linear-gradient(to right, #5c636a, #495057); box-shadow: 0 6px 12px rgba(108, 117, 125, 0.3); transform: translateY(-2px); }
    .file-upload-wrapper { margin-bottom: 20px; }
    .file-upload-area {
      border: 3px dashed #cbd5e1; border-radius: 12px; padding: 40px 30px; text-align: center;
      background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%); transition: all 0.3s ease; cursor: pointer; position: relative;
    }
    .file-upload-area:hover {
      border-color: #0b5ed7; background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%); transform: translateY(-2px);
    }
    .file-upload-area.dragover {
      border-color: #0b5ed7; background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%); box-shadow: 0 10px 30px rgba(11, 94, 215, 0.2);
    }
    .upload-icon { width: 50px; height: 50px; margin: 0 auto 15px; color: #0b5ed7; opacity: 0.8; }
    .file-upload-area p { margin: 0; color: #333; }
    .upload-title { font-weight: 600; font-size: 16px; margin: 15px 0 8px; }
    .upload-subtitle { font-size: 13px; color: #718096; }
    .file-input { display: none; }
    .file-info { margin-top: 12px; color: #0b5ed7; font-weight: 500; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .file-info.error { color: #e53e3e; }
    .checkmark { width: 18px; height: 18px; background: #0b5ed7; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }
    .form-actions { display: flex; gap: 12px; margin-top: 40px; }
    .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) {
      form { grid-template-columns: 1fr; }
      .form-container { padding: 20px; }
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h1>Add State-wise Data</h1>
    <div class="subtitle">Enter state-wise data and upload relevant documents.</div>
    <form id="addStateWiseDataForm">
      <div class="form-section">Basic Information</div>
      <div class="form-group">
        <label for="name" class="required">Discom Name</label>
        <input type="text" id="name" name="name" required />
      </div>
      <div class="form-group">
        <label for="state" class="required">State</label>
        <select id="state" name="state" required>
          <option value="">Select State</option>
          <option>Andhra Pradesh</option><option>Arunachal Pradesh</option><option>Assam</option><option>Bihar</option><option>Chhattisgarh</option><option>Goa</option><option>Gujarat</option><option>Haryana</option><option>Himachal Pradesh</option><option>Jharkhand</option><option>Karnataka</option><option>Kerala</option><option>Madhya Pradesh</option><option>Maharashtra</option><option>Manipur</option><option>Meghalaya</option><option>Mizoram</option><option>Nagaland</option><option>Odisha</option><option>Punjab</option><option>Rajasthan</option><option>Sikkim</option><option>Tamil Nadu</option><option>Telangana</option><option>Tripura</option><option>Uttar Pradesh</option><option>Uttarakhand</option><option>West Bengal</option><option>Delhi</option>
        </select>
      </div>
      <div class="form-section">Capacity Details</div>
      <div class="form-group">
        <label for="psa_signed_mw" class="required">PSA Signed (MW)</label>
        <input type="number" step="0.01" id="psa_signed_mw" name="psa_signed_mw" required />
      </div>
      <div class="form-group">
        <label for="commissioned_mw" class="required">Commissioned (MW)</label>
        <input type="number" step="0.01" id="commissioned_mw" name="commissioned_mw" required />
      </div>
      <div class="form-section">Documents</div>
      <div class="form-group">
        <label for="regulationsFile" class="required">Regulations / Policy</label>
        <small class="form-text">PDF, DOC, DOCX allowed (Max 50 MB)</small>
        <div class="file-upload-wrapper">
          <div class="file-upload-area" id="regulationsUploadArea">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <p class="upload-title">Upload Regulations / Policy</p>
            <p class="upload-subtitle">Click to upload or drag and drop</p>
            <input type="file" class="file-input" id="regulationsFile" name="regulations_file" accept=".pdf,.doc,.docx,.txt" multiple />
          </div>
          <div id="regulationsFileName" class="file-info"></div>
        </div>
      </div>
      <div class="form-group">
        <label for="reportFile">Report (Optional)</label>
        <small class="form-text">PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, JPG, PNG (Max 50 MB)</small>
        <div class="file-upload-wrapper">
          <div class="file-upload-area" id="reportUploadArea">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <p class="upload-title">Upload Report</p>
            <p class="upload-subtitle">Click to upload or drag and drop</p>
            <input type="file" class="file-input" id="reportFile" name="report_file" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.png" />
          </div>
          <div id="reportFileName" class="file-info"></div>
        </div>
      </div>
      <input type="hidden" id="deptId" name="dept_id" />
      <input type="hidden" id="statisticId" name="statistic_id" />
      <input type="hidden" id="entityId" name="entity_id" />
      <div class="form-actions full-width">
        <button type="submit" class="btn-submit" id="submitBtn">✓ Submit</button>
      </div>
    </form>
  </div>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const deptId = urlParams.get("dept_id");
    const statisticId = urlParams.get("statistic_id");
    const entityId = urlParams.get("entity_id");
    document.getElementById("deptId").value = deptId;
    document.getElementById("statisticId").value = statisticId;
    document.getElementById("entityId").value = entityId;
    // File upload handlers for both file inputs
    function setupFileUploadArea(uploadAreaId, fileInputId, fileNameId) {
      const uploadArea = document.getElementById(uploadAreaId);
      const fileInput = document.getElementById(fileInputId);
      const fileName = document.getElementById(fileNameId);
      uploadArea.addEventListener("click", () => fileInput.click());
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault(); uploadArea.classList.add("dragover");
      });
      uploadArea.addEventListener("dragleave", () => uploadArea.classList.remove("dragover"));
      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault(); uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) { fileInput.files = files; updateFileName(fileInput, fileName); }
      });
      fileInput.addEventListener("change", () => updateFileName(fileInput, fileName));
    }
    function updateFileName(fileInput, fileNameDiv) {
      if (fileInput.files.length > 0) {
        let filesInfo = [];
        for (let i = 0; i < fileInput.files.length; i++) {
          const file = fileInput.files[i];
          const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
          filesInfo.push(`<span class=\"checkmark\">✓</span> ${file.name} (${sizeMB} MB)`);
        }
        fileNameDiv.innerHTML = filesInfo.join('<br>');
        fileNameDiv.classList.remove("error");
      } else {
        fileNameDiv.textContent = "";
      }
    }
    setupFileUploadArea("regulationsUploadArea", "regulationsFile", "regulationsFileName");
    setupFileUploadArea("reportUploadArea", "reportFile", "reportFileName");
    function authFetch(url, options = {}) {
      const token = localStorage.getItem("token");
      const defaultHeaders = { Authorization: `Bearer ${token}` };
      return fetch(url, {
        ...options,
        headers: { ...defaultHeaders, ...(options.headers || {}) },
      }).then((res) => {
        if (res.status === 401) {
          alert("Session expired. Redirecting to login...");
          localStorage.clear();
          window.location.href = "/";
          throw new Error("Unauthorized");
        }
        return res;
      });
    }
    document.getElementById("addStateWiseDataForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const submitBtn = document.getElementById("submitBtn");
      const name = document.getElementById("name").value.trim();
      const state = document.getElementById("state").value.trim();
      const psa_signed_mw = document.getElementById("psa_signed_mw").value;
      const commissioned_mw = document.getElementById("commissioned_mw").value;
      
      // Validate required IDs
      if (!deptId || !statisticId || !entityId) {
        alert("Error: Missing department, statistic, or entity ID. Please access this form from the correct workflow or contact admin.");
        return;
      }
      
      // Validate required fields
      if (!name) {
        alert("Error: Discom Name is required.");
        return;
      }
      
      if (!state) {
        alert("Error: State is required. Please select a state from the dropdown.");
        return;
      }
      try {
        submitBtn.disabled = true;
        submitBtn.textContent = "⏳ Uploading...";
        // Upload files first (if provided) and get stored paths
        let report_path = null;
        const regulationsFiles = document.getElementById("regulationsFile").files;
        const reportFile = document.getElementById("reportFile").files[0];
        const uploadSingle = async (file) => {
          const fd = new FormData();
          fd.append("file", file);
          const resp = await authFetch(`/api/data/documents/upload-file`, { method: "POST", body: fd });
          if (!resp.ok) throw new Error("File upload failed");
          const json = await resp.json();
          return json.path;
        };
        let regulations_paths = [];
        const uploads = [];
        if (regulationsFiles && regulationsFiles.length > 0) {
          for (let i = 0; i < regulationsFiles.length; i++) {
            uploads.push(uploadSingle(regulationsFiles[i]).then(p => regulations_paths.push(p)));
          }
        }
        if (reportFile) uploads.push(uploadSingle(reportFile).then(p => report_path = p));
        await Promise.all(uploads);
        // Now post the state-wise data with paths returned from uploads
        const response = await authFetch(
          `/api/data/state-wise-data/${deptId}/${statisticId}/${entityId}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name,
              state,
              psa_signed_mw: parseFloat(psa_signed_mw),
              commissioned_mw: parseFloat(commissioned_mw),
              regulations_policy: regulations_paths.length > 1 ? JSON.stringify(regulations_paths) : (regulations_paths[0] || null),
              report_path,
            }),
          }
        );
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || error.error || "Failed to add state-wise data.");
        }
        alert("State-wise data added successfully!");
        window.location.href = `/external_emd.html?dept_id=${deptId}&statistic_id=${statisticId}&entity_id=${entityId}`;
      } catch (err) {
        console.error(err);
        submitBtn.disabled = false;
        submitBtn.textContent = "✓ Submit";
        alert("Error adding state-wise data: " + err.message);
      }
    });
  </script>
</body>
</html>
